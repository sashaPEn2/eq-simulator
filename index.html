<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EQ Simulator: Multiplayer</title>
    
    <!-- React & Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs (Compat version for browser usage) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: white; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø—É–ª—å—Å–∞—Ü–∏–∏ –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è */
        .pulse-ring { animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
        @keyframes pulse-ring { 0% { transform: scale(0.33); } 80%, 100% { opacity: 0; } }
    </style>
</head>
<body>
    <div id="root" class="min-h-screen flex items-center justify-center p-4 w-full"></div>

    <!-- –í–ï–°–¨ –ö–û–î –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø –ù–ê–•–û–î–ò–¢–°–Ø –ó–î–ï–°–¨ -->
    <script type="text/babel">
        // --- CONFIGURATION & SCENARIOS ---
        const scenarios = [
            {
                id: 1,
                title: "–ü—Ä–æ–ø–∞–≤—à–∏–π –¢–∏–º–º–µ–π—Ç",
                context: "–î–µ–¥–ª–∞–π–Ω –∑–∞–≤—Ç—Ä–∞. –¢–∏–º–º–µ–π—Ç –í–∞—Å—è –º–æ–ª—á–∏—Ç 2 –¥–Ω—è, –Ω–æ –ø–æ—Å—Ç–∏—Ç —Å—Ç–æ—Ä–∏—Å. –ß—Ç–æ –¥–µ–ª–∞–µ–º?",
                image: "üì±",
                options: [
                    { id: 'A', text: "–ù–∞–µ—Ö–∞—Ç—å –≤ –æ–±—â–µ–º —á–∞—Ç–µ ('–¢—ã –æ—Ñ–∏–≥–µ–ª?')", type: "reactive", feedback: "–ö–æ–Ω—Ñ–ª–∏–∫—Ç –∏ —Å—Ç—Ä–µ—Å—Å.", color: "red" },
                    { id: 'B', text: "–°–¥–µ–ª–∞—Ç—å —Å–∞–º–æ–º—É –º–æ–ª—á–∞ –∏ –æ–±–∏–¥–µ—Ç—å—Å—è", type: "passive", feedback: "–í—ã–≥–æ—Ä–∞–Ω–∏–µ –∏ –æ–±–∏–¥–∞.", color: "yellow" },
                    { id: 'C', text: "–ù–∞–ø–∏—Å–∞—Ç—å –ª–∏—á–Ω–æ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–ª–∞–Ω", type: "proactive", feedback: "–†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã.", color: "green" }
                ]
            },
            {
                id: 2,
                title: "–ù–µ—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–∞—è –û—Ü–µ–Ω–∫–∞",
                context: "–ü—Ä–µ–ø–æ–¥ –ø–æ—Å—Ç–∞–≤–∏–ª 3, —Ö–æ—Ç—è —Ä–∞–±–æ—Ç–∞ –∏–¥–µ–∞–ª—å–Ω–∞. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: '–¢–µ–º–∞ –Ω–µ —Ä–∞—Å–∫—Ä—ã—Ç–∞'.",
                image: "üéì",
                options: [
                    { id: 'A', text: "–ì—Ä–æ–º–∫–æ –≤–æ–∑–º—É—Ç–∏—Ç—å—Å—è –ø—Ä–∏ –≤—Å–µ—Ö", type: "reactive", feedback: "–ò—Å–ø–æ—Ä—á–µ–Ω–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è.", color: "red" },
                    { id: 'B', text: "–°–ø—Ä–æ—Å–∏—Ç—å –ø–æ—Å–ª–µ –ø–∞—Ä—ã: '–ß—Ç–æ —É–ª—É—á—à–∏—Ç—å?'", type: "proactive", feedback: "–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–π –¥–∏–∞–ª–æ–≥.", color: "green" },
                    { id: 'C', text: "–ü—Ä–æ–º–æ–ª—á–∞—Ç—å –∏ –∂–∞–ª–æ–≤–∞—Ç—å—Å—è –¥—Ä—É–∑—å—è–º", type: "passive", feedback: "–†—É–º–∏–Ω–∞—Ü–∏—è (–∑–∞—Å—Ç—Ä–µ–≤–∞–Ω–∏–µ).", color: "yellow" }
                ]
            },
            {
                id: 3,
                title: "–í–µ—á–µ—Ä–∏–Ω–∫–∞ vs –≠–∫–∑–∞–º–µ–Ω",
                context: "–ó–∞–≤—Ç—Ä–∞ —Å–ª–æ–∂–Ω—ã–π –∑–∞—á–µ—Ç. –î—Ä—É–∑—å—è –∑–æ–≤—É—Ç –Ω–∞ —Ç—É—Å–æ–≤–∫—É –≤–µ–∫–∞. –û—á–µ–Ω—å —Ö–æ—á–µ—Ç—Å—è –ø–æ–π—Ç–∏.",
                image: "üéâ",
                options: [
                    { id: 'A', text: "–ü–æ–π—Ç–∏ –∏ –Ω–∞–¥–µ—è—Ç—å—Å—è –Ω–∞ —É–¥–∞—á—É", type: "reactive", feedback: "–¢—Ä–µ–≤–æ–≥–∞ —É—Ç—Ä–æ–º.", color: "red" },
                    { id: 'B', text: "–û—Å—Ç–∞—Ç—å—Å—è –¥–æ–º–∞ –∏ –∑–ª–∏—Ç—å—Å—è", type: "passive", feedback: "–ù–∏–∑–∫–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.", color: "yellow" },
                    { id: 'C', text: "–ó–∞–µ—Ö–∞—Ç—å –Ω–∞ —á–∞—Å –ø–æ–∑–¥—Ä–∞–≤–∏—Ç—å –∏ —É–µ—Ö–∞—Ç—å", type: "proactive", feedback: "–ë–∞–ª–∞–Ω—Å –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å.", color: "green" }
                ]
            },
            // --- –ù–û–í–´–ï –°–¶–ï–ù–ê–†–ò–ò ---
            {
                id: 4,
                title: "–ñ–µ—Å—Ç–∫–∞—è –ö—Ä–∏—Ç–∏–∫–∞",
                context: "–í–∞—à —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –ø—É–±–ª–∏—á–Ω–æ —Ä–∞—Å–∫—Ä–∏—Ç–∏–∫–æ–≤–∞–ª –≤–∞—à –æ—Ç—á–µ—Ç. –í–∞–º —Å—Ç—ã–¥–Ω–æ –∏ –æ–±–∏–¥–Ω–æ.",
                image: "üî•",
                options: [
                    { id: 'A', text: "–°—Ä–∞–∑—É –Ω–∞—á–∞—Ç—å —Å–ø–æ—Ä–∏—Ç—å –∏ –∑–∞—â–∏—â–∞—Ç—å—Å—è.", type: "reactive", feedback: "–≠—Å–∫–∞–ª–∞—Ü–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞.", color: "red" },
                    { id: 'B', text: "–ú–æ–ª—á–∞ –ø—Ä–∏–Ω—è—Ç—å –∫—Ä–∏—Ç–∏–∫—É, –Ω–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ —Ä–µ—à–∏—Ç—å, —á—Ç–æ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –Ω–µ–ø—Ä–∞–≤.", type: "passive", feedback: "–ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –Ω–µ–≥–∞—Ç–∏–≤–∞.", color: "yellow" },
                    { id: 'C', text: "–ü–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç—å, –∞ –∑–∞—Ç–µ–º –ø–æ–ø—Ä–æ—Å–∏—Ç—å 1 –Ω–∞ 1 –æ–±—Å—É–¥–∏—Ç—å –¥–µ—Ç–∞–ª–∏ —É–ª—É—á—à–µ–Ω–∏—è.", type: "proactive", feedback: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏–∫–∏ –¥–ª—è —Ä–æ—Å—Ç–∞.", color: "green" }
                ]
            },
            {
                id: 5,
                title: "–ö–æ–ª–ª–µ–≥–∞ –≤ –ë–µ–¥–µ",
                context: "–ö–æ–ª–ª–µ–≥–∞, –∫–æ—Ç–æ—Ä—ã–π —á–∞—Å—Ç–æ –ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∏—Ä—É–µ—Ç, –ø—Ä–æ—Å–∏—Ç —Å—Ä–æ—á–Ω–æ –ø–æ–º–æ—á—å —Å –µ–≥–æ —Ä–∞–±–æ—Ç–æ–π, —Ö–æ—Ç—è —É –≤–∞—Å –¥–µ–¥–ª–∞–π–Ω.",
                image: "ü§ù",
                options: [
                    { id: 'A', text: "–°–∫–∞–∑–∞—Ç—å '–≠—Ç–æ –Ω–µ –º–æ–∏ –ø—Ä–æ–±–ª–µ–º—ã' –∏ –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è.", type: "reactive", feedback: "–†–∞–∑—Ä—ã–≤ –æ—Ç–Ω–æ—à–µ–Ω–∏–π.", color: "red" },
                    { id: 'B', text: "–ë—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∏ –ø–æ–º–æ—á—å –µ–º—É, –∑–∞–±—ã–≤ –æ —Å–≤–æ–µ–º –¥–µ–¥–ª–∞–π–Ω–µ.", type: "passive", feedback: "–ü–æ–¥—Ä—ã–≤ —Å–≤–æ–∏—Ö –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤.", color: "yellow" },
                    { id: 'C', text: "–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å 15 –º–∏–Ω—É—Ç, —á—Ç–æ–±—ã –≤–º–µ—Å—Ç–µ —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø–ª–∞–Ω –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–∏ –µ–≥–æ –∑–∞–¥–∞—á, –∞ –ø–æ—Ç–æ–º –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–≤–æ–µ–π.", type: "proactive", feedback: "–ü–æ–º–æ—â—å –∏ –≥—Ä–∞–Ω–∏—Ü—ã.", color: "green" }
                ]
            },
            {
                id: 6,
                title: "–ü—Ä–æ–≤–∞–ª –ü—Ä–æ–µ–∫—Ç–∞",
                context: "–ü—Ä–æ–µ–∫—Ç –ø—Ä–æ–≤–∞–ª–∏–ª—Å—è, –∏ –≤—Å–µ –∏—â—É—Ç '–∫—Ä–∞–π–Ω–µ–≥–æ'. –í—ã –∑–Ω–∞–µ—Ç–µ, —á—Ç–æ –¥–æ–ø—É—Å—Ç–∏–ª–∏ –º–µ–ª–∫—É—é –æ—à–∏–±–∫—É, –∫–æ—Ç–æ—Ä–∞—è —É—Å—É–≥—É–±–∏–ª–∞ –ø—Ä–æ–±–ª–µ–º—É.",
                image: "‚ùå",
                options: [
                    { id: 'A', text: "–ü–µ—Ä–µ–ª–æ–∂–∏—Ç—å –≤–∏–Ω—É –Ω–∞ —Ç–æ–≥–æ, –∫—Ç–æ –¥–æ–ø—É—Å—Ç–∏–ª —Å–∞–º—É—é –±–æ–ª—å—à—É—é –æ—à–∏–±–∫—É.", type: "reactive", feedback: "–ü–æ—Ç–µ—Ä—è –¥–æ–≤–µ—Ä–∏—è.", color: "red" },
                    { id: 'B', text: "–ü—Ä–æ–º–æ–ª—á–∞—Ç—å –∏ –Ω–∞–¥–µ—è—Ç—å—Å—è, —á—Ç–æ –Ω–∏–∫—Ç–æ –Ω–µ –∑–∞–º–µ—Ç–∏—Ç –≤–∞—à –≤–∫–ª–∞–¥.", type: "passive", feedback: "–¢–∞–π–Ω–æ–µ —á—É–≤—Å—Ç–≤–æ –≤–∏–Ω—ã.", color: "yellow" },
                    { id: 'C', text: "–í–∑—è—Ç—å –Ω–∞ —Å–µ–±—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ —Å–≤–æ—é —á–∞—Å—Ç—å –æ—à–∏–±–∫–∏ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–ª–∞–Ω –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é.", type: "proactive", feedback: "–ü—Ä–æ—è–≤–ª–µ–Ω–∏–µ –ª–∏–¥–µ—Ä—Å—Ç–≤–∞ –∏ —á–µ—Å—Ç–Ω–æ—Å—Ç–∏.", color: "green" }
                ]
            }
        ];

        // --- FIREBASE INIT (–í–ê–®–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø) ---
        // –í–ê–®–ò –î–ê–ù–ù–´–ï FIREBASE –í–°–¢–ê–í–õ–ï–ù–´ –ù–ò–ñ–ï
        const myFirebaseConfig = {
            apiKey: "AIzaSyC8oVyi8yR1DHQUzSU7fIkMx0w5_saR2xs",
            authDomain: "game-5e865.firebaseapp.com",
            projectId: "game-5e865",
            storageBucket: "game-5e865.firebasestorage.app",
            messagingSenderId: "891966924074",
            appId: "1:891966924074:web:57595104fe79f28902aa53"
        };
        const firebaseConfig = myFirebaseConfig;
        
        // –í–ê–ñ–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = firebaseConfig.projectId; // –ò—Å–ø–æ–ª—å–∑—É–µ–º projectId (game-5e865) –∫–∞–∫ appId –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è, –∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ —Å—Ä–µ–¥–æ–π Canvas
        const __initial_auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;


        // --- COMPONENTS ---

        function App() {
            const [user, setUser] = React.useState(null);
            const [view, setView] = React.useState('menu'); // menu, host, player
            const [roomCode, setRoomCode] = React.useState('');
            const [playerName, setPlayerName] = React.useState('');
            const [error, setError] = React.useState('');

            // Auth Initialization
            React.useEffect(() => {
                const initAuth = async () => {
                    try {
                         if (__initial_auth_token) {
                            // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ —Å—Ä–µ–¥–µ Canvas), –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
                            await auth.signInWithCustomToken(__initial_auth_token);
                         } else {
                            // –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –∏–ª–∏ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ç–æ–∫–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–Ω–æ–Ω–∏–º–Ω—ã–π –≤—Ö–æ–¥
                            await auth.signInAnonymously();
                         }
                    } catch (e) {
                        console.error("Auth error", e);
                        setError("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
                    }
                };
                initAuth();
                const unsubscribe = auth.onAuthStateChanged((u) => setUser(u));
                return () => unsubscribe();
            }, []);

            if (!user) return <div className="text-xl animate-pulse text-blue-400">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º—ã...</div>;

            // --- NAVIGATION HANDLERS ---
            
            const createRoom = async () => {
                const code = Math.floor(1000 + Math.random() * 9000).toString();
                
                try {
                    // Reference to the room document
                    // –ü—É—Ç—å: artifacts/game-5e865/public/data/room_XXXX/status
                    const roomDocRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection(`room_${code}`).doc('status');
                    
                    await roomDocRef.set({
                        hostId: user.uid,
                        status: 'lobby', // lobby, playing, results
                        currentScenario: 0,
                        showFeedback: false,
                        createdAt: Date.now()
                    });
                    
                    setRoomCode(code);
                    setView('host');
                } catch (e) {
                    console.error(e);
                    setError("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã: " + e.message);
                }
            };

            const joinRoom = async () => {
                if (!roomCode || roomCode.length !== 4) {
                    setError("–í–≤–µ–¥–∏—Ç–µ 4-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥");
                    return;
                }
                if (!playerName) {
                    setError("–í–≤–µ–¥–∏—Ç–µ –∏–º—è");
                    return;
                }

                try {
                    const roomDocRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection(`room_${roomCode}`).doc('status');
                    
                    // Firestore Compat syntax for getting a document
                    const roomSnap = await roomDocRef.get();
                    
                    if (!roomSnap.exists) {
                        setError("–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
                        return;
                    }

                    // Register player. Collection: artifacts/game-5e865/public/data/room_XXXX_players/{userId}
                    const playerRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection(`room_${roomCode}_players`).doc(user.uid);
                    
                    await playerRef.set({
                        name: playerName,
                        score: 0,
                        joinedAt: Date.now()
                    });

                    setView('player');
                } catch (e) {
                    console.error(e);
                    setError("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: " + e.message);
                }
            };

            // --- RENDER VIEWS ---

            if (view === 'menu') {
                return (
                    <div className="max-w-md w-full space-y-8 text-center fade-in">
                        <h1 className="text-5xl font-black bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">
                            EQ Simulator
                        </h1>
                        <p className="text-gray-400">–ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä –≤–µ—Ä—Å–∏—è. User ID: <span className="text-xs text-slate-500">{user.uid}</span></p>
                        
                        <div className="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-xl space-y-4">
                            <h2 className="text-xl font-bold text-white">–î–ª—è –í–µ–¥—É—â–µ–≥–æ</h2>
                            <button onClick={createRoom} className="w-full py-3 bg-blue-600 hover:bg-blue-500 rounded-lg font-bold transition">
                                –°–æ–∑–¥–∞—Ç—å –ö–æ–º–Ω–∞—Ç—É
                            </button>
                        </div>

                        <div className="relative flex py-2 items-center">
                            <div className="flex-grow border-t border-slate-700"></div>
                            <span className="flex-shrink mx-4 text-gray-500">–ò–õ–ò</span>
                            <div className="flex-grow border-t border-slate-700"></div>
                        </div>

                        <div className="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-xl space-y-4">
                            <h2 className="text-xl font-bold text-white">–î–ª—è –°—Ç—É–¥–µ–Ω—Ç–∞</h2>
                            <input 
                                type="text" 
                                placeholder="–í–∞—à–µ –ò–º—è"
                                className="w-full p-3 bg-slate-900 rounded border border-slate-600 focus:border-blue-500 outline-none text-white"
                                value={playerName}
                                onChange={e => setPlayerName(e.target.value)}
                            />
                            <input 
                                type="number" 
                                placeholder="–ö–æ–¥ –ö–æ–º–Ω–∞—Ç—ã (4 —Ü–∏—Ñ—Ä—ã)"
                                className="w-full p-3 bg-slate-900 rounded border border-slate-600 focus:border-blue-500 outline-none text-white tracking-widest text-center font-mono text-xl"
                                value={roomCode}
                                onChange={e => setRoomCode(e.target.value)}
                            />
                            {error && <p className="text-red-400 text-sm">{error}</p>}
                            <button onClick={joinRoom} className="w-full py-3 bg-green-600 hover:bg-green-500 rounded-lg font-bold transition">
                                –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
                            </button>
                        </div>
                    </div>
                );
            }

            if (view === 'host') {
                return <HostView roomCode={roomCode} user={user} db={db} appId={appId} />;
            }

            if (view === 'player') {
                return <PlayerView roomCode={roomCode} user={user} db={db} appId={appId} />;
            }

            return null;
        }

        // --- HOST VIEW ---

        function HostView({ roomCode, user, db, appId }) {
            const [roomData, setRoomData] = React.useState(null);
            const [players, setPlayers] = React.useState([]);

            // Listen to room state
            React.useEffect(() => {
                const roomDocRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection(`room_${roomCode}`).doc('status');
                
                // –í–ê–ñ–ù–û: –î–æ–±–∞–≤—å—Ç–µ appId –∏ db –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ eslint (—Ö–æ—Ç—è –≤ Canvas —ç—Ç–æ —á–∞—Å—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)
                const unsubRoom = roomDocRef.onSnapshot((doc) => {
                    setRoomData(doc.data());
                }, (err) => console.error("Room sync error", err));

                // Listen to players
                const playersColRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection(`room_${roomCode}_players`);
                
                // –í–ê–ñ–ù–û: –î–æ–±–∞–≤—å—Ç–µ appId –∏ db –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
                const unsubPlayers = playersColRef.onSnapshot((snapshot) => {
                    const pList = [];
                    snapshot.forEach(doc => pList.push({ id: doc.id, ...doc.data() }));
                    setPlayers(pList);
                }, (err) => console.error("Players sync error", err));

                return () => { unsubRoom(); unsubPlayers(); };
            }, [roomCode, appId, db]); // –î–æ–±–∞–≤–∏–ª –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

            const nextStep = async () => {
                if (!roomData) return;
                const roomDocRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection(`room_${roomCode}`).doc('status');
                
                if (roomData.status === 'lobby') {
                    await roomDocRef.update({ status: 'playing', currentScenario: 0, showFeedback: false });
                } else if (roomData.showFeedback) {
                    // Move to next question or end
                    if (roomData.currentScenario < scenarios.length - 1) {
                        await roomDocRef.update({ 
                            currentScenario: roomData.currentScenario + 1, 
                            showFeedback: false,
                        });
                    } else {
                        await roomDocRef.update({ status: 'end' });
                    }
                } else {
                    // Show feedback for current question
                    await roomDocRef.update({ showFeedback: true });
                }
            };

            if (!roomData) return <div className="text-center text-xl mt-10">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–Ω–∞—Ç—ã...</div>;

            // Lobby State
            if (roomData.status === 'lobby') {
                return (
                    <div className="max-w-4xl w-full text-center fade-in">
                        <div className="mb-8">
                            <h2 className="text-gray-400 uppercase tracking-widest text-sm mb-2">–ö–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞</h2>
                            <div className="text-8xl font-black text-white font-mono tracking-widest bg-slate-800 inline-block px-8 py-4 rounded-2xl border-2 border-slate-600 shadow-2xl">
                                {roomCode}
                            </div>
                            <p className="text-sm text-gray-500 mt-2">ID –í–µ–¥—É—â–µ–≥–æ: {user.uid}</p>
                        </div>

                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                            {players.map(p => (
                                <div key={p.id} className="bg-slate-800 p-3 rounded-lg border border-slate-700 animate-pulse">
                                    üë§ {p.name}
                                </div>
                            ))}
                            {players.length === 0 && <div className="col-span-4 text-gray-500 italic">–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤...</div>}
                        </div>

                        <div className="fixed bottom-8 left-0 right-0 flex justify-center">
                            <button 
                                onClick={nextStep}
                                className="bg-blue-600 hover:bg-blue-500 text-white px-12 py-4 rounded-full text-2xl font-bold shadow-lg transition transform hover:scale-105"
                                disabled={players.length === 0}
                            >
                                –ù–∞—á–∞—Ç—å –ò–≥—Ä—É ({players.length} —á–µ–ª.)
                            </button>
                        </div>
                    </div>
                );
            }

            // End State
            if (roomData.status === 'end') {
                return (
                    <div className="max-w-2xl w-full text-center fade-in">
                        <h1 className="text-4xl font-bold mb-8">üéâ –ò–≥—Ä–∞ –ó–∞–≤–µ—Ä—à–µ–Ω–∞!</h1>
                        <div className="bg-slate-800 rounded-xl overflow-hidden border border-slate-700">
                            <table className="w-full text-left">
                                <thead className="bg-slate-900 text-slate-400">
                                    <tr>
                                        <th className="p-4">–ò–≥—Ä–æ–∫</th>
                                        <th className="p-4 text-right">EQ Score</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {players.sort((a,b) => (b.score || 0) - (a.score || 0)).map((p, i) => (
                                        <tr key={p.id} className="border-t border-slate-700">
                                            <td className="p-4 flex items-center gap-2">
                                                <span className="text-gray-500 w-6">#{i+1}</span>
                                                {p.name}
                                            </td>
                                            <td className="p-4 text-right font-bold text-green-400">{p.score || 0}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            }

            // Game State
            const scenario = scenarios[roomData.currentScenario];
            const currentAnswers = players.filter(p => p[`answer_${roomData.currentScenario}`]);
            
            // Calculate stats
            const stats = { A: 0, B: 0, C: 0 };
            currentAnswers.forEach(p => {
                const ans = p[`answer_${roomData.currentScenario}`];
                if(stats[ans] !== undefined) stats[ans]++;
            });
            const total = currentAnswers.length || 1; // avoid div by zero

            return (
                <div className="w-full max-w-6xl grid grid-cols-1 lg:grid-cols-3 gap-6 p-4 h-screen max-h-[900px]">
                    {/* Left: Scenario */}
                    <div className="lg:col-span-2 bg-slate-800 p-8 rounded-2xl border border-slate-700 flex flex-col justify-center relative">
                        <div className="absolute top-4 right-4 text-6xl opacity-20">{scenario.image}</div>
                        <h2 className="text-3xl font-bold mb-6 text-blue-300">–°–∏—Ç—É–∞—Ü–∏—è {roomData.currentScenario + 1}</h2>
                        <p className="text-2xl leading-relaxed mb-8">{scenario.context}</p>
                        
                        <div className="grid gap-4">
                            {scenario.options.map(opt => {
                                const count = stats[opt.id];
                                const percent = Math.round((count / total) * 100);
                                const isCorrect = opt.type === 'proactive';

                                return (
                                    <div key={opt.id} className={`relative p-6 rounded-xl border-2 transition-all ${
                                        roomData.showFeedback 
                                            ? (isCorrect ? 'border-green-500 bg-green-900/20' : 'border-slate-700 opacity-50')
                                            : 'border-slate-600 bg-slate-700/50'
                                    }`}>
                                        <div className="flex justify-between items-center z-10 relative">
                                            <span className="font-bold text-xl mr-4">{opt.id}. {opt.text}</span>
                                            {roomData.showFeedback && <span className="text-2xl font-bold">{count}</span>}
                                        </div>
                                        
                                        {/* Progress Bar background */}
                                        {roomData.showFeedback && (
                                            <div className="absolute left-0 top-0 bottom-0 bg-white/10 transition-all duration-1000" style={{width: `${percent}%`}}></div>
                                        )}
                                        
                                        {roomData.showFeedback && isCorrect && (
                                            <div className="mt-2 text-green-400 font-bold">‚ú® –õ—É—á—à–∏–π –≤—ã–±–æ—Ä: {opt.feedback}</div>
                                        )}
                                         {roomData.showFeedback && !isCorrect && opt.id === 'A' && ( 
                                            <div className="mt-2 text-red-400 text-sm">{opt.feedback}</div>
                                        )}
                                         {roomData.showFeedback && !isCorrect && opt.id === 'B' && (
                                            <div className="mt-2 text-yellow-400 text-sm">{opt.feedback}</div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* Right: Controls & Players */}
                    <div className="flex flex-col gap-4">
                        <div className="bg-slate-900 p-6 rounded-2xl border border-slate-800 flex-grow overflow-y-auto">
                            <h3 className="text-gray-400 mb-4 font-bold uppercase text-sm">–û—Ç–≤–µ—Ç–∏–ª–∏: {currentAnswers.length}/{players.length}</h3>
                            <div className="flex flex-wrap gap-2">
                                {players.map(p => {
                                    const hasAnswered = p[`answer_${roomData.currentScenario}`];
                                    return (
                                        <span key={p.id} className={`px-3 py-1 rounded-full text-sm ${hasAnswered ? 'bg-blue-600 text-white' : 'bg-slate-800 text-gray-500 border border-slate-700'}`}>
                                            {p.name} {hasAnswered && '‚úì'}
                                        </span>
                                    );
                                })}
                            </div>
                        </div>

                        <button 
                            onClick={nextStep}
                            className="w-full py-6 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-2xl text-xl shadow-lg transition"
                        >
                            {roomData.showFeedback 
                                ? (roomData.currentScenario < scenarios.length - 1 ? "–°–ª–µ–¥—É—é—â–∞—è –°–∏—Ç—É–∞—Ü–∏—è ->" : "–ó–∞–≤–µ—Ä—à–∏—Ç—å –ò–≥—Ä—É") 
                                : "–ü–æ–∫–∞–∑–∞—Ç—å –†–µ–∑—É–ª—å—Ç–∞—Ç—ã"}
                        </button>
                    </div>
                </div>
            );
        }

        // --- PLAYER VIEW ---

        function PlayerView({ roomCode, user, db, appId }) {
            const [roomData, setRoomData] = React.useState(null);
            const [hasAnswered, setHasAnswered] = React.useState(false);

            React.useEffect(() => {
                const roomDocRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection(`room_${roomCode}`).doc('status');
                
                // –í–ê–ñ–ù–û: –î–æ–±–∞–≤—å—Ç–µ roomCode, appId, db –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
                const unsub = roomDocRef.onSnapshot((doc) => {
                    if (doc.exists) {
                        setRoomData(doc.data());
                    }
                });
                return () => unsub();
            }, [roomCode, appId, db]);

            // Check if we already answered this specific scenario
            React.useEffect(() => {
                if (!roomData || !user) return;
                const checkAnswer = async () => {
                    const playerRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection(`room_${roomCode}_players`).doc(user.uid);
                    
                    const snap = await playerRef.get();
                    if (snap.exists) {
                        const data = snap.data();
                        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ hasAnswered –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, –µ—Å—Ç—å –ª–∏ –æ—Ç–≤–µ—Ç –Ω–∞ —Ç–µ–∫—É—â–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π
                        setHasAnswered(!!data[`answer_${roomData.currentScenario}`]);
                    }
                };
                checkAnswer();
            }, [roomData?.currentScenario, user?.uid, roomCode, appId, db]); // –î–æ–±–∞–≤–∏–ª –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏


            const submitAnswer = async (optionId, type) => {
                if (hasAnswered) return;
                
                // –ù–∞—á–∏—Å–ª—è–µ–º –±–∞–ª–ª—ã: –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–π (10), –ü–∞—Å—Å–∏–≤–Ω—ã–π (0), –†–µ–∞–∫—Ç–∏–≤–Ω—ã–π (-5)
                const points = type === 'proactive' ? 10 : type === 'passive' ? 0 : -5;
                const playerRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection(`room_${roomCode}_players`).doc(user.uid);

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º FieldValue.increment –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç–∞
                // –í–ê–ñ–ù–û: FieldValue –¥–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑ firebase.firestore.FieldValue
                await playerRef.update({
                    [`answer_${roomData.currentScenario}`]: optionId,
                    score: firebase.firestore.FieldValue.increment(points)
                });
                setHasAnswered(true);
            };

            if (!roomData) return <div className="p-10 text-center">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ...</div>;

            if (roomData.status === 'lobby') {
                return (
                    <div className="text-center p-8 max-w-md w-full">
                        <div className="w-20 h-20 bg-blue-600 rounded-full mx-auto mb-6 flex items-center justify-center pulse-ring">
                            <span className="text-3xl">‚è≥</span>
                        </div>
                        <h2 className="text-2xl font-bold mb-2">–û–∂–∏–¥–∞–µ–º –≤–µ–¥—É—â–µ–≥–æ...</h2>
                        <p className="text-gray-400">–°–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ –±–æ–ª—å—à–æ–π —ç–∫—Ä–∞–Ω.</p>
                        <div className="mt-8 p-4 bg-slate-800 rounded-lg">
                            –í–∞—à–µ –∏–º—è: <span className="font-bold text-white">{user.displayName || "–°—Ç—É–¥–µ–Ω—Ç"}</span>
                        </div>
                    </div>
                );
            }

            if (roomData.status === 'end') {
                return (
                    <div className="text-center p-8 max-w-md w-full">
                        <h2 className="text-3xl font-bold mb-4">–ò–≥—Ä–∞ –û–∫–æ–Ω—á–µ–Ω–∞!</h2>
                        <p>–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ —ç–∫—Ä–∞–Ω –≤–µ–¥—É—â–µ–≥–æ, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.</p>
                    </div>
                );
            }

            const scenario = scenarios[roomData.currentScenario];

            if (roomData.showFeedback) {
                return (
                    <div className="text-center p-8 max-w-md w-full">
                        <div className="mb-6">
                            {hasAnswered ? <div className="text-6xl mb-4 text-green-400">üëÄ</div> : <div className="text-6xl mb-4 text-gray-500">üò¥</div>}
                            <h2 className="text-2xl font-bold">–°–º–æ—Ç—Ä–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã!</h2>
                            <p className="text-gray-400 mt-2">–í–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω</p>
                        </div>
                        <div className="p-4 bg-slate-800 rounded-xl border border-slate-700 animate-pulse">
                            –û–∂–∏–¥–∞–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞...
                        </div>
                    </div>
                );
            }

            return (
                <div className="w-full max-w-md p-4 space-y-4">
                    <div className="bg-slate-800 p-4 rounded-xl border-l-4 border-blue-500 mb-4">
                        <h3 className="text-gray-400 text-xs uppercase tracking-widest mb-1">–°–∏—Ç—É–∞—Ü–∏—è {roomData.currentScenario + 1}</h3>
                        <p className="font-bold text-lg">{scenario.title}</p>
                        <p className="text-sm text-gray-300 mt-2">{scenario.context}</p>
                    </div>

                    <div className="space-y-3">
                        {hasAnswered ? (
                             <div className="text-center py-10">
                                <div className="text-green-500 text-5xl mb-4">‚úì</div>
                                <h3 className="text-xl font-bold">–û—Ç–≤–µ—Ç –ø—Ä–∏–Ω—è—Ç</h3>
                                <p className="text-gray-400">–ñ–¥–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã—Ö...</p>
                             </div>
                        ) : (
                            scenario.options.map(opt => (
                                <button
                                    key={opt.id}
                                    onClick={() => submitAnswer(opt.id, opt.type)}
                                    className="w-full text-left p-6 bg-slate-700 hover:bg-blue-600 active:bg-blue-700 rounded-xl border-2 border-slate-600 transition-all transform active:scale-95 group"
                                >
                                    <div className="flex items-center gap-4">
                                        <div className="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center font-bold text-lg group-hover:bg-white group-hover:text-blue-600 transition-colors">
                                            {opt.id}
                                        </div>
                                        <div className="text-lg font-medium">{opt.text}</div>
                                    </div>
                                </button>
                            ))
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>